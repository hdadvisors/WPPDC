---
title: "PDC Master Parcels Analysis"
subtitle: "Summary Statistics & Interactive Mapping"
author: "Planning District Commission"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: true
    code-summary: "Show code"
    theme: cosmo
    embed-resources: true
    fig-width: 10
    fig-height: 8
execute:
  warning: false
  message: false
---

```{r setup}
#| include: false

library(tidyverse)
library(sf)
library(leaflet)
library(tigris)
library(knitr)
library(kableExtra)

# Set options
options(tigris_use_cache = TRUE)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load-data}
#| include: false

# Load the CSV dataset (for tabular analysis)
parcels <- read.csv("analyzed_data/pdc_master_parcels.csv")

# Load the spatial dataset (for mapping)
parcels_spatial <- st_read("analyzed_data/pdc_parcels_spatial.gpkg", quiet = TRUE)

# Get Virginia county boundaries
va_counties <- counties(state = "VA", cb = TRUE) %>%
  st_transform(4326)

# Filter to PDC region
pdc_localities <- c("Danville city", "Henry County", "Martinsville city", 
                    "Pittsylvania County", "Patrick County", "Franklin County")

pdc_boundaries <- va_counties %>%
  filter(NAMELSAD %in% pdc_localities)
```

## Executive Summary

This analysis examines **`r format(nrow(parcels), big.mark = ",")`** parcels across the West Piedmont Planning District Commission region, representing a total assessed value of $`r format(sum(parcels$total_value, na.rm = TRUE), big.mark = ",")`** and covering approximately **`r format(round(sum(parcels\$acres, na.rm = TRUE), 0), big.mark = ",")\` acres.

------------------------------------------------------------------------

## 1. Geographic Distribution

### Parcels by Locality

```{r locality-summary}
locality_summary <- parcels %>%
  group_by(locality) %>%
  summarise(
    `Parcel Count` = n(),
    `Total Acres` = round(sum(acres, na.rm = TRUE), 1),
    `Average Acres` = round(mean(acres, na.rm = TRUE), 2),
    `Median Acres` = round(median(acres, na.rm = TRUE), 2),
    .groups = "drop"
  ) %>%
  mutate(
    `% of Parcels` = round(`Parcel Count` / sum(`Parcel Count`) * 100, 1),
    `% of Acres` = round(`Total Acres` / sum(`Total Acres`) * 100, 1)
  ) %>%
  arrange(desc(`Parcel Count`))

locality_summary %>%
  kable(format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE)
```

### Key Findings

```{r locality-insights}
top_locality <- locality_summary %>% slice(1)
most_acres <- locality_summary %>% arrange(desc(`Total Acres`)) %>% slice(1)
```

-   **`r top_locality$locality`** contains the most parcels (**`r format(top_locality$'Parcel Count', big.mark = ",")`**, `r top_locality$'% of Parcels'`% of total)
-   **`r most_acres$locality`** has the largest land area (**`r format(most_acres$'Total Acres', big.mark = ",")`** acres, `r most_acres$'% of Acres'`% of total)

------------------------------------------------------------------------

## 2. Zoning Analysis

### Zone Category Distribution

```{r zone-category}
zone_category_summary <- parcels %>%
  count(zone_category, name = "Parcel Count") %>%
  mutate(
    `Percentage` = round(`Parcel Count` / sum(`Parcel Count`) * 100, 1)
  ) %>%
  arrange(desc(`Parcel Count`))

zone_category_summary %>%
  kable(format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE)
```

```{r zone-category-chart}
#| fig-height: 6

ggplot(zone_category_summary, aes(x = reorder(zone_category, `Parcel Count`), 
                                   y = `Parcel Count`, 
                                   fill = zone_category)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(
    "Agricultural" = "#8baeaa",
    "Commercial" = "#e9ab3f",
    "Economic Development" = "#c75b42",
    "Government/Special" = "#5a8a84",
    "Industrial" = "#e76f52",
    "Office/Commercial" = "#d4a03a",
    "Other" = "#bdc3c7",
    "Residential" = "#445ca9",
    "Unzoned" = "#95a5a6"
  )) +
  labs(
    title = "Parcel Count by Zone Category",
    x = NULL,
    y = "Number of Parcels"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 14))
```

### Top 15 Specific Zoning Designations

```{r zone-names}
zone_name_summary <- parcels %>%
  count(zone_name, name = "Parcel Count") %>%
  mutate(
    `Percentage` = round(`Parcel Count` / sum(`Parcel Count`) * 100, 1)
  ) %>%
  arrange(desc(`Parcel Count`)) %>%
  head(15)

zone_name_summary %>%
  kable(format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE)
```

------------------------------------------------------------------------

## 3. Assessed Value Analysis

### Overall Value Statistics

```{r value-overall}
overall_values <- parcels %>%
  summarise(
    `Total Assessed Value` = sum(total_value, na.rm = TRUE),
    `Total Land Value` = sum(land_value, na.rm = TRUE),
    `Total Improvement Value` = `Total Assessed Value` - `Total Land Value`,
    `Average Parcel Value` = mean(total_value, na.rm = TRUE),
    `Median Parcel Value` = median(total_value, na.rm = TRUE),
    `Minimum Parcel Value` = min(total_value, na.rm = TRUE),
    `Maximum Parcel Value` = max(total_value, na.rm = TRUE)
  )

overall_values %>%
  pivot_longer(everything(), names_to = "Metric", values_to = "Value") %>%
  mutate(Value = paste0("$", format(round(Value, 0), big.mark = ","))) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE)
```

### Value by Locality

```{r value-locality}
value_by_locality <- parcels %>%
  group_by(locality) %>%
  summarise(
    `Parcel Count` = n(),
    `Total Value` = sum(total_value, na.rm = TRUE),
    `Land Value` = sum(land_value, na.rm = TRUE),
    `Average Value` = round(mean(total_value, na.rm = TRUE), 0),
    `Median Value` = round(median(total_value, na.rm = TRUE), 0),
    .groups = "drop"
  ) %>%
  mutate(
    `% of Total Value` = round(`Total Value` / sum(`Total Value`) * 100, 1)
  ) %>%
  arrange(desc(`Total Value`))

value_by_locality %>%
  mutate(
    `Total Value` = paste0("$", format(`Total Value`, big.mark = ",")),
    `Land Value` = paste0("$", format(`Land Value`, big.mark = ",")),
    `Average Value` = paste0("$", format(`Average Value`, big.mark = ",")),
    `Median Value` = paste0("$", format(`Median Value`, big.mark = ","))
  ) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE)
```

### Value by Zone Category

```{r value-zone}
value_by_zone <- parcels %>%
  group_by(zone_category) %>%
  summarise(
    `Parcel Count` = n(),
    `Total Value` = sum(total_value, na.rm = TRUE),
    `Average Value` = round(mean(total_value, na.rm = TRUE), 0),
    `Median Value` = round(median(total_value, na.rm = TRUE), 0),
    .groups = "drop"
  ) %>%
  mutate(
    `% of Total Value` = round(`Total Value` / sum(`Total Value`) * 100, 1)
  ) %>%
  arrange(desc(`Total Value`))

value_by_zone %>%
  mutate(
    `Total Value` = paste0("$", format(`Total Value`, big.mark = ",")),
    `Average Value` = paste0("$", format(`Average Value`, big.mark = ",")),
    `Median Value` = paste0("$", format(`Median Value`, big.mark = ","))
  ) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE)
```

```{r value-zone-chart}
#| fig-height: 6

value_by_zone_chart <- parcels %>%
  group_by(zone_category) %>%
  summarise(
    total_value = sum(total_value, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(value_by_zone_chart, aes(x = reorder(zone_category, total_value), 
                                  y = total_value/1e6, 
                                  fill = zone_category)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::dollar_format(suffix = "M")) +
  scale_fill_manual(values = c(
    "Agricultural" = "#8baeaa",
    "Commercial" = "#e9ab3f",
    "Economic Development" = "#c75b42",
    "Government/Special" = "#5a8a84",
    "Industrial" = "#e76f52",
    "Office/Commercial" = "#d4a03a",
    "Other" = "#bdc3c7",
    "Residential" = "#445ca9",
    "Unzoned" = "#95a5a6"
  )) +
  labs(
    title = "Total Assessed Value by Zone Category",
    x = NULL,
    y = "Total Value (Millions)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 14))
```

------------------------------------------------------------------------

## 4. Interactive Parcel Map

Explore individual parcels by clicking on them to view detailed information including address, zoning, acreage, and assessed value.

```{r interactive-map}
#| fig-height: 10

# Transform parcels to WGS84
parcels_wgs84 <- st_transform(parcels_spatial, 4326)

# Zone category color palette
zone_levels <- c(
  "Agricultural",
  "Commercial", 
  "Economic Development",
  "Government/Special",
  "Industrial",
  "Office/Commercial",
  "Other",
  "Residential",
  "Unzoned"
)

zone_colors <- c(
  "#8baeaa",   # Agricultural
  "#e9ab3f",   # Commercial
  "#c75b42",   # Economic Development
  "#5a8a84",   # Government/Special
  "#e76f52",   # Industrial
  "#d4a03a",   # Office/Commercial
  "#bdc3c7",   # Other
  "#445ca9",   # Residential
  "#95a5a6"    # Unzoned
)

zone_pal <- colorFactor(
  palette = zone_colors,
  levels = zone_levels,
  na.color = "#cccccc"
)

# Create map
leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  
  # Add county/city boundaries
  addPolygons(
    data = pdc_boundaries,
    fillColor = "transparent",
    fillOpacity = 0,
    color = "#333333",
    weight = 2,
    opacity = 1,
    label = ~NAMELSAD
  ) %>%
  
  # Add parcels
  addPolygons(
    data = parcels_wgs84,
    fillColor = ~zone_pal(zone_category),
    fillOpacity = 0.7,
    color = "white",
    weight = 0.5,
    popup = ~paste0(
      "<strong>", address, "</strong><br>",
      "<hr style='margin: 5px 0;'>",
      "<b>Locality:</b> ", locality, "<br>",
      "<b>Zoning:</b> ", zone_name, "<br>",
      "<b>Category:</b> ", zone_category, "<br>",
      "<b>Acres:</b> ", round(acres, 2), "<br>",
      "<b>Total Value:</b> $", format(total_value, big.mark = ","), "<br>",
      "<b>Land Value:</b> $", format(land_value, big.mark = ",")
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  
  # Add legend
  addLegend(
    position = "bottomright",
    pal = zone_pal,
    values = parcels_wgs84$zone_category,
    title = "Zone Category",
    opacity = 0.7
  ) %>%
  
  # Add scale bar
  addScaleBar(position = "bottomleft")
```

------------------------------------------------------------------------

## Appendix: Data Sources & Methodology

### Data Sources

-   Parcel data: PDC Master Parcels Database, supplied by the PDC 
-   Geographic boundaries: U.S. Census Bureau TIGER/Line Shapefiles
-   Analysis date: `r Sys.Date()`

### Methodology

-   Spatial analysis conducted using R packages: `sf`, `leaflet`, `tigris`
-   Zone categories standardized across jurisdictions for comparative analysis
-   Assessed values represent total assessed value (land + improvements)
-   Geographic analysis uses WGS84 coordinate reference system (EPSG:4326)

### Contact

For questions about this analysis, please contact the West Piedmont Planning District Commission.
